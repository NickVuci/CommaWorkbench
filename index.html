<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RTT Comma Workbench — Refactor</title>
<link rel="stylesheet" href="styles/base.css" />
<link rel="stylesheet" href="styles/layout.css" />
<link rel="stylesheet" href="styles/components.css" />
</head>
<body>
<header>
  <h1>RTT Comma Workbench — Refactor</h1>
  <div class="sub">Find notable commas → see which EDOs temper them → enumerate comma pumps (via monzos)</div>
</header>
<main>
  <div class="steps-grid">
    <section class="step-column" aria-label="Step 1">
      <section class="card step-metric">
        <div class="metric-line">
          <div class="metric-value" id="kpiCommas">0</div>
          <div class="metric-label">Notable commas</div>
        </div>
      </section>
      <section class="card">
        <h2>Step 1: Find Notable Commas</h2>
        <label for="primeInput">Prime subgroup / limit</label>
        <input id="primeInput" type="text" value="5" placeholder="Examples: 5  (≙ 2,3,5)   or   2,5,7" />
        <div class="hint">Enter a single prime to use a full prime-limit (e.g., "5" → 2,3,5) or a comma-separated list for a subgroup (e.g., "2,5,7").</div>
        <div class="row" style="margin-top:10px;">
          <div>
            <label>Exponent bound (±)</label>
            <input type="number" id="expBound" value="5" min="2" max="9" />
          </div>
          <div>
            <label>Max comma size (cents)</label>
            <input type="number" id="maxCents" value="30" min="5" max="60" step="1" />
          </div>
        </div>
        <div class="actions">
          <button id="runBtn">Run Query</button>
          <button class="secondary" id="clearBtn">Clear Results</button>
        </div>
      </section>
      <section class="card dataset-card">
        <h3 style="margin-top:14px;">Comma Catalog</h3>
        <div class="table-scroll">
          <table id="commaTable"><thead><tr>
            <th>Ratio</th><th>Monzo</th><th>Cents</th>
          </tr></thead><tbody></tbody></table>
        </div>
      </section>
    </section>

    <section class="step-column" aria-label="Step 2">
      <section class="card step-metric">
        <div class="metric-line">
          <div class="metric-value" id="kpiPairs">0</div>
          <div class="metric-label">EDO–comma matches</div>
        </div>
      </section>
      <section class="card">
        <h2>Step 2: Analyze Commas & EDOs</h2>
        <div class="row" style="margin-top:10px;">
          <div>
            <label>EDO min</label>
            <input type="number" id="edoMin" value="5" min="2" max="120" />
          </div>
          <div>
            <label>EDO max</label>
            <input type="number" id="edoMax" value="72" min="2" max="240" />
          </div>
        </div>
      </section>
      <section class="card dataset-card">
        <h3 style="margin-top:14px;">EDOs Tempering Selected Comma</h3>
        <div class="table-scroll">
          <table id="edoTable"><thead><tr>
            <th>EDO</th>
          </tr></thead><tbody></tbody></table>
        </div>
      </section>
    </section>

    <section class="step-column" aria-label="Step 3">
      <section class="card step-metric">
        <div class="metric-line">
          <div class="metric-value" id="kpiSteps">0</div>
          <div class="metric-label">Steps generated</div>
        </div>
      </section>
      <section class="card">
        <h2>Step 3: Define & Filter Interval Vocabulary</h2>
        <div class="row" style="margin-top:10px;">
          <div>
            <label for="oddLimit">Odd limit</label>
            <input id="oddLimit" type="number" value="11" min="3" max="99" />
          </div>
          <div>
            <label for="edoApproxTol">EDO approximation tolerance (¢)</label>
            <input id="edoApproxTol" type="number" value="3" min="0" max="30" step="0.5" />
          </div>
        </div>
        <div class="actions" style="margin-bottom:8px;">
          <button class="secondary" id="regenStepsBtn">Regenerate Steps</button>
          <button class="secondary" id="selectAllStepsBtn">Select All</button>
          <button class="secondary" id="clearStepsBtn">Clear Selection</button>
        </div>
      </section>
      <section class="card dataset-card">
        <h3 style="margin-top:14px;">Prime & Odd-Limit Steps</h3>
        <div class="chips" id="stepsChips"></div>
        <div class="hint" style="margin-top:6px;">Auto-generated reduced ratios (within one octave) whose odd limit ≤ chosen value and factors are in your primes. Select 3–5 for nicer pumps.</div>
      </section>
    </section>

    <section class="step-column" aria-label="Step 4">
      <section class="card step-metric">
        <div class="metric-line">
          <div class="metric-value" id="kpiPumps">0</div>
          <div class="metric-label">Pumps shown</div>
        </div>
      </section>
      <section class="card">
        <h2>Step 4: Find Comma Pumps</h2>
        <div class="row" style="margin-top:10px;">
          <div>
            <label>Step coefficient bound (±)</label>
            <input type="number" id="coeffBound" value="6" min="1" max="16" />
          </div>
          <div>
            <label>Max steps (L1 cap)</label>
            <input type="number" id="maxL1Steps" value="999" min="1" max="9999" />
          </div>
          <div style="display:flex;align-items:center;gap:6px;">
            <input type="checkbox" id="canonicalizePumps" />
            <label for="canonicalizePumps">Canonicalize pumps (experimental)</label>
          </div>
        </div>
        <div class="actions" style="margin-top:10px;">
          <button id="runPumpsBtn">Run Pump Search</button>
        </div>
        <div class="hint">Select a comma in Step 1, adjust your vocabulary in Step 3, then run the pump search.</div>
      </section>
      <section class="card dataset-card">
        <h3 style="margin-top:14px;">Comma Pumps (selected comma)</h3>
        <div class="hint">Each row solves <span class="mono">S·x = c</span> exactly.</div>
        <div id="pumpEquivalences" class="equivalences" style="display:none;"></div>
        <div id="pumpProgress" class="progress" style="display:none;">
          <div class="row">
            <div class="bar"><div class="fill" style="width:0%"></div></div>
            <div class="eta" id="pumpEta">ETA: —</div>
          </div>
          <div class="row">
            <div class="status" id="pumpStatus">Waiting…</div>
            <button id="pumpCancel" class="secondary small">Cancel</button>
          </div>
        </div>
        <div class="table-scroll" style="margin-top:8px;">
          <table id="pumpTable"><thead><tr>
            <th></th><th>Step Recipe (x)</th><th>L1</th>
          </tr></thead><tbody></tbody></table>
        </div>
      </section>
      <section class="card dataset-card pump-preview-card">
        <h3 style="margin-top:14px;">Pump Preview (experimental)</h3>
        <div id="pumpPreviewPanel" class="pump-preview-panel" data-state="idle">
          <div class="preview-empty" data-slot="empty">Select a pump row to stage audio + stack view experiments.</div>
          <div class="preview-body" data-slot="body">
            <div class="preview-meta">
              <div class="preview-title" data-slot="title">Pump preview placeholder</div>
              <div class="preview-summary" data-slot="summary">Step recipe details will appear here once a pump is selected.</div>
            </div>
            <div class="preview-modes">
              <span class="chip" data-mode="ji" role="button" tabindex="0">JI</span>
              <span class="chip muted" data-mode="edo" role="button" tabindex="0">Select an EDO to enable</span>
            </div>
            <div class="preview-controls">
              <label for="pumpPreviewBaseHz">Base pitch (Hz)
                <input type="number" id="pumpPreviewBaseHz" value="440" min="55" max="1760" step="1" />
              </label>
            </div>
            <div class="preview-note" data-slot="note">Awaiting pump selection.</div>
            <div class="preview-chart" data-slot="chart">
              <div class="chart-empty">Select a pump to view the trajectory.</div>
            </div>
            <div class="preview-walk" data-slot="walkTable"></div>
            <div class="preview-transport">
              <button class="secondary small" id="pumpPreviewPlay" disabled>Play</button>
              <button class="secondary small" id="pumpPreviewStop" disabled>Stop</button>
              <label class="preview-loop">
                <input type="checkbox" id="pumpPreviewLoop" disabled />
                Loop pump
              </label>
            </div>
          </div>
        </div>
      </section>
      <details>
        <summary>Diagnostics & Self-Tests</summary>
        <section class="card">
          <div class="actions">
            <button class="secondary" id="testBtn">Run Self‑Tests</button>
          </div>
          <table id="testTable" style="margin-top:8px;"><thead><tr><th>#</th><th>Test</th><th>Result</th><th>Notes</th></tr></thead><tbody></tbody></table>
        </section>
      </details>
    </section>
  </div>
</main>

<script type="module" src="src/main.js"></script>
</body>
</html>
